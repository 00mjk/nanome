docker.enabled = true

params {
	executor = 'google-lifesciences'

	// tools' specific options
	GuppyGPUOptions="--gpu_runners_per_device 16 --device auto"
	GuppyNumCallers=16
	megalodonGPUOptions="--devices 0"
	DeepSignal_isgpu = 'no'

	processors=16
}

google {
	lifeSciences.bootDiskSize = params.gls_bootDiskSize
	lifeSciences.preemptible = params.gls_preemptible
	zone = params.zone
	network = params.network
	subnetwork = params.subnetwork
}

process {
	echo = params.echo

	container = params.containerName

	cpus = params.resquiggle_cpus
	memory =  params.resquiggle_memory
	errorStrategy = { task.exitStatus==14 ? 'retry' : 'terminate' }
	maxRetries = 3

  	withLabel: with_gpus {
		echo = params.echo

		container = params.containerName
		containerOptions = params.containerOptions
		cpus = params.with_gpus_process_cpus
		memory =  params.with_gpus_process_memory
		accelerator = [request: params.n_accelerators, type: params.accelerator ]
		errorStrategy = { task.exitStatus==14 ? 'retry' : 'terminate' }
		maxRetries = 3
	}

	withName: Resquiggle {
		cpus = params.resquiggle_cpus
		memory =  params.resquiggle_memory
	}

	withName: Tombo {
		cpus = params.resquiggle_cpus
		memory =  params.resquiggle_memory
		// exit=32 means 'Broken pipe' bug in Tombo
		errorStrategy = { task.exitStatus in [14, 32] ? 'retry' : 'terminate' }
	}

	withName: Megalodon { // We may need add memory for Megalodon, so we put it here for special one
		containerOptions = params.containerOptions

		cpus = params.with_gpus_process_cpus
		memory =  params.with_gpus_process_memory
		accelerator = [request: params.n_accelerators, type: params.accelerator ]
	}
}
